---
date: "2022-11-14"
title: "tWIL 2022.11 2ì£¼ì°¨"
draft: false
summary: "This week I learned"
featured: /static/images/eunchurn/watering.PNG
categories:
  - blog
tags:
  - development
  - terraform
  - vscode
  - supertokens
  - prisma
  - apollo server
  - apollo client
  - apollo explorer
  - graphql
  - react
  - bastion
  - aws s3
  - aws cloudfront
---

ì£¼ë§ì— ì½”ê°ê¸°ë¡œ ì¸í•´ ì»¨ë””ì…˜ì´ ë–¨ì–´ì ¸ì„œ ì›”ìš”ì¼ì— tWILë¥¼ ì“°ê²Œ ë˜ì—ˆë‹¤. ì¼ì£¼ì¼ ì •ë„ ë³´ì¶©ì œ íœ´ì•½ì„ í–ˆë”ë‹ˆ ë©´ì—­ì²´ê³„ê°€ ë¬´ë„ˆì§„ ë“¯ í•˜ë‹¤.

ê¸°ì¡´ Auth ì»¨í…Œì´ë„ˆë¥¼ ë³„ê°œì˜ ECS Clusterë¡œ êµ¬ì¶•í–ˆì—ˆë‹¤. í•˜ì§€ë§Œ Auth ì»¨í…Œì´ë„ˆëŠ” Private subnetì— ìœ„ì¹˜í•˜ê³  internal load balancerë¥¼ ë¶™ì—¬ì•¼ ë§ì„ ê²ƒ ê°™ë‹¤. ê·¸ë˜ì„œ ALBëŠ” API ì»¨í…Œì´ë„ˆ ì„œë¹„ìŠ¤ì— ì—°ê²°í•˜ê³ , Auth ì»¨í…Œì´ë„ˆë¥¼ Private ì»¨í…Œì´ë„ˆë¡œ ì¬êµ¬ì¶•ì„ í•˜ì˜€ë‹¤. ì´ ë¸”ë¡œê·¸ [Provisioning Multiple ECS Services Using Terraform](https://towardsaws.com/provisioning-multiple-ecs-services-using-terraform-d4448354c803)ë¥¼ ì°¸ê³ í•˜ì—¬ ì¸í”„ë¼ ìˆ˜ì •ì„ ì§„í–‰í•˜ì˜€ë‹¤.

ë°°í¬í–ˆë˜ SuperTokens ì»¨í…Œì´ë„ˆëŠ” ê°™ì€ AWS ECS í´ëŸ¬ìŠ¤í„°ì•ˆì— ì„œë¹„ìŠ¤ë¥¼ ë¶„ë¦¬í•˜ì˜€ë‹¤. SuperTokensì´ ë™ì‘í•˜ëŠ” ì›ë¦¬ëŠ” ì´ë¯¸ì§€ì²˜ëŸ¼ API ë’¤ì—ì„œ ë™ì‘í•˜ê³  RDBì˜ Security Groupì— ìˆì–´ì•¼ í•œë‹¤.

![supertokens self hosted](/static/images/2022/11/self_hosted_generic.png)

ì´ëŸ¬í•œ ë°©ì‹ìœ¼ë¡œ [ê¸°ì¡´ ECS](https://github.com/eunchurn/terraform-ecs-codeploy-blue-green)ì— CodeBuild, CodePipelineì„ ë¶™ì—¬ Terraformì„ êµ¬ì„±í•˜ì˜€ë‹¤. ì¶”ê°€ë¡œ APIì™€ Clientë¥¼ ëª¨ë‘ Terraformì˜ CodePipelineìœ¼ë¡œ ë¶™ì—¬ì„œ ì „ì²´ ì¸í”„ë¼ë¥¼ í•œ ê³³ì— ëª¨ì•˜ë‹¤.

![terraform-ecs-multiple-services](/static/images/2022/11/terraform-ecs-multiple-services.png)

ì¶”ê°€ëœ ëª¨ë“ˆë“¤ì€ Bastion, SuperTokens ì»¨í…Œì´ë„ˆ ì„œë¹„ìŠ¤ ê·¸ë¦¬ê³  Client WebApp (ì—¬ê¸°ì„œëŠ” CRAë¡œ ë¹Œë“œí•˜ëŠ” React ì•±ì„ ì‚¬ìš©, NextjsëŠ” ì¸í”„ë¼ êµ¬ì„±ì´ ì¢€ ë‹¤ë¥´ë‹¤.) ì£¼ëª©í•´ì•¼í•˜ëŠ” ì ì€ íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥ì´ ìˆê¸° ë•Œë¬¸ì— S3 ë²„í‚·ì˜ ì£¼ì†Œì™€ IAMì„ ë³„ë„ë¡œ ë§Œë“¤ì–´ì£¼ì—ˆë‹¤. ê·¸ë¦¬ê³  ì´ ì•¡ì„¸ìŠ¤ í† í°ì„ APIì— ì„¤ì •í•˜ê³  ë²„í‚·ì´ë¦„ì„ ê¸°ë°˜ìœ¼ë¡œ íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ì„¤ì •í•œë‹¤.

### Bastion

ì˜› ì „íˆ¬ì—ì„œ ì„±ì„ ì§€í‚¤ê¸° ìœ„í•´ ëŒì¶œëœ ë¶€ë¶„ì„ ì˜ë¯¸í•œë‹¤ê³  í•œë‹¤. ì—¬ê¸°ì—ì„œëŠ” RDSì™€ ECS ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ ì¼ì¢…ì˜ ì‘ì€ í†µë¡œë¼ê³  ìƒê°í•˜ê³  ë³¸ë‹¤ë©´ AWS EC2ì—ì„œ í‚¤ë¥¼ í•˜ë‚˜ ë°œê¸‰ë°›ì•„ ì´ë¦„ì„ ì§€ì •í•´ ë†“ëŠ”ë‹¤. ì¶”í›„ ì´ í‚¤ íŒŒì¼ì€ ë°±ì—”ë“œ ê°œë°œìë“¤ë§Œ ê³µìœ ë˜ì–´ì•¼ í•œë‹¤. ê·¸ë¦¬ê³  ì–¸ì œë“ ì§€ ì´ Bastionì€ ì—†ì• ê³  ìƒˆë¡œìš´ í‚¤ë¥¼ ë°œê¸‰ë°›ì•„ ìƒˆë¡œ Bastionì„ ìƒì„±í•  ìˆ˜ë„ ìˆì–´ì•¼ í•œë‹¤. ì—¬ê¸°ì„œëŠ” [Best Practiceì˜ ëª¨ë“ˆ](https://github.com/Guimove/terraform-aws-bastion)ì„ ì—°ê²°í•˜ì—¬ ì‚¬ìš©í•˜ì˜€ë‹¤. `bastion_host_key_pair`ê°’ì„ ì•ì„œ ë°œê¸‰í•œ `pem`í‚¤ì˜ ì´ë¦„ìœ¼ë¡œ ì„¤ì •í•´ì¤€ë‹¤.

```hcl:main.tf
module "bastion" {
  source = "./modules/bastion"

  bucket_name                = "bastion-log-${terraform.workspace}-mystack"
  region                     = var.region
  vpc_id                     = module.networks.vpc_id
  is_lb_private              = false
  bastion_host_key_pair      = "bastion"
  create_dns_record          = true
  hosted_zone_id             = module.api.route53_staged_zone.id
  bastion_record_name        = "bastion.${module.api.route53_staged_zone.name}"
  bastion_iam_policy_name    = "bastion-policy-${terraform.workspace}"
  elb_subnets                = [module.networks.public_subnet_1, module.networks.public_subnet_2]
  auto_scaling_group_subnets = [module.networks.private_subnet_1, module.networks.private_subnet_2]
  bucket_force_destroy       = true
  tags = {
    "Name"        = "bastion-${var.application_name}-${terraform.workspace}",
    "description" = "Terraform Bastion server ${var.application_name}-${terraform.workspace}"
  }
}
```

### SuperTokens Services

ì•ì„œ API ì„œë¹„ìŠ¤ë¥¼ ìœ„í•´ ìƒì„±í•œ ECS í´ëŸ¬ìŠ¤í„°ì— ì„œë¹„ìŠ¤ë¥¼ ì¶”ê°€í•œë‹¤.

```hcl:main.tf
data "aws_ecs_cluster" "cluster" {
  cluster_name = var.ecs_cluster.name
  depends_on = [
    var.api_cluster_depends_on
  ]
}
```

ì—¬ê¸°ì„œ í´ëŸ¬ìŠ¤í„° IDë¥¼ ê°€ì ¸ì™€ì„œ ë¶™ì—¬ì¤€ë‹¤.

```hcl:main.tf
resource "aws_ecs_service" "auth" {
  name                   = local.container_name
  task_definition        = "${aws_ecs_task_definition.supertokens.family}:${max("${aws_ecs_task_definition.supertokens.revision}", "${aws_ecs_task_definition.supertokens.revision}")}"
  desired_count          = 1
  launch_type            = "FARGATE"
  cluster                = data.aws_ecs_cluster.cluster.id
  enable_execute_command = true

  network_configuration {
    security_groups  = flatten(["${var.network.security_groups_ids}", "${module.auth-sg.ecs_security_group.id}"])
    subnets          = flatten(["${var.network.private_subnets_id}"])
    assign_public_ip = true
  }

  propagate_tags          = "TASK_DEFINITION"
  enable_ecs_managed_tags = true

  health_check_grace_period_seconds = 30

  deployment_circuit_breaker {
    enable   = false
    rollback = false
  }

  deployment_controller {
    type = "ECS"
  }

  load_balancer {
    target_group_arn = module.auth-alb.aws_target_group.arn
    container_name   = local.container_name
    container_port   = var.auth_container_port
  }

  tags = {
    Environment = "${terraform.workspace}"
  }

  # ë§¤ë²ˆ ECS serviceê°€ êµì²´ë˜ëŠ” ì´ìŠˆ https://github.com/hashicorp/terraform-provider-aws/issues/11526
  lifecycle {
    ignore_changes = [
      cluster,
      iam_role,
      id,
      platform_version
    ]
  }
}
```

SuperTokensì˜ Task Definitionì„ ì •ì˜í•œë‹¤. Registry ì´ë¦„ì€ [Running the docker image](https://supertokens.com/docs/thirdpartyemailpassword/pre-built-ui/setup/core/with-docker)ì—ì„œ ì°¸ê³ í•˜ì˜€ë‹¤.

```hcl:main.tf
resource "aws_ecs_task_definition" "supertokens" {
  family                   = local.container_name
  container_definitions    = <<DEFINITION
  [
    {
      "name": "${local.container_name}",
      "image": "registry.supertokens.io/supertokens/supertokens-postgresql",
      "essential": true,
      "portMappings": [
        {
          "containerPort": 3567,
          "hostPort": 3567
        }
      ],
      "memory": 512,
      "cpu": 256,
      "secrets": [
        {
          "name": "API_KEYS",
          "valueFrom": "/${var.application_name}/${terraform.workspace}/API_SECRET"
        },
        {
          "name": "POSTGRESQL_CONNECTION_URI",
          "valueFrom": "/${var.application_name}/${terraform.workspace}/POSTGRESQL_CONNECTION_URI"
        }
      ],
      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "${aws_cloudwatch_log_group.auth_log.name}",
          "awslogs-region": "${var.region}",
          "awslogs-stream-prefix": "ecs"
        }
      }
    }
  ]
  DEFINITION
  requires_compatibilities = ["FARGATE"]
  network_mode             = "awsvpc"
  memory                   = 512
  cpu                      = 256
  execution_role_arn       = module.auth-iam.ecs_execution_role.arn
  task_role_arn            = module.auth-iam.ecs_execution_role.arn
}
```

ê·¸ë¦¬ê³  **Internal Load balancer**ë¥¼ ë¶™ì—¬ ì¤€ë‹¤.

```hcl:auth-alb/main.tf {3} showLineNumbers
resource "aws_alb" "alb_auth_application" {
  name            = "${var.application_name}-auth-${terraform.workspace}-${var.random_id_prefix}-alb"
  internal        = true
  subnets         = flatten(["${var.private_subnet_ids}"])
  security_groups = flatten(["${var.security_groups_ids}", "${var.ecs_security_group.id}", "${var.alb_security_group.id}"])
  lifecycle {
    create_before_destroy = true
  }
  tags = {
    Name        = "${var.application_name}-auth-${terraform.workspace}-${var.random_id_prefix}-alb"
    Environment = "${terraform.workspace}"
  }
}
```

ë¡œë“œë°¸ëŸ°ì„œì™€ ë³´ì•ˆê·¸ë£¹ì„ ë§Œë“¤ê³  RDS ë³´ì•ˆê·¸ë£¹ê³¼ APIë³´ì•ˆê·¸ë£¹ì— ë¶™ì—¬ì£¼ë©´, SuperTokensëŠ” ì¸í„°ë„ë¡œ ì ‘ì† ê°€ëŠ¥ìƒíƒœë¡œ ë°°í¬ê°€ ëœë‹¤. Bastion ì„œë²„ë¡œ ì ‘ì†í•˜ì—¬

```sh
curl auth.platform.mystack.io/hello
```

ë¡œ ë‹¨ìˆœí•˜ê²Œ health checkê°€ ê°€ëŠ¥í•˜ë‹¤.

### Client Web App

ì§€ë‚œë²ˆ React í”„ë¡œì íŠ¸ë§Œ ë°°í¬í•˜ëŠ” Terraform ì½”ë“œì— ëª¨ë“ˆí™”ë§Œ í•œë‹¨ê³„ ì¶”ê°€í•œë‹¤. ReactëŠ” S3ì— ë°°í¬í•˜ê³  CloudFrontì—ì„œ CDN ë°°í¬í•œë‹¤. React íŠ¹íˆ CRAì—ì„œ í™˜ê²½ë³€ìˆ˜ëŠ” ëŸ°íƒ€ì„ì´ ì•„ë‹ˆë¼ ë¹Œë“œíƒ€ì„ì— ì„¤ì •ëœë‹¤ëŠ” ê²ƒì„ ê°ì•ˆí•˜ë©´, CodeBuildì— í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•œë‹¤. ì•Œë‹¤ ì‹œí”¼ ì•±ì—ì„œ ì‚¬ìš©í•  í™˜ê²½ë³€ìˆ˜ëŠ” `REACT_APP` í”„ë¦¬í”½ìŠ¤ê°€ ë˜ì–´ìˆì–´ì•¼ í•œë‹¤.

```hcl:codlebuild.tf
resource "aws_codebuild_project" "frontend_build_project" {
  name          = "${var.application_name}_frontend_${var.environment}"
  description   = "codebuild stage"
  service_role  = aws_iam_role.codebuild_frontend.arn
  build_timeout = var.build_timeout

  artifacts {
    type = "CODEPIPELINE"
  }

  cache {
    type     = "S3"
    location = "${var.codebuild_bucket_name}-${var.environment}/_cache/archives"
  }

  source {
    type      = "CODEPIPELINE"
    buildspec = "./buildspec.yml"
  }

  environment {
    compute_type    = "BUILD_GENERAL1_SMALL"
    image           = var.codebuild_image
    type            = "LINUX_CONTAINER"
    privileged_mode = true

    environment_variable {
      name  = "ENV"
      value = var.environment
    }

    environment_variable {
      name  = "S3_BUCKET_DESTINATION"
      value = var.s3_bucket_destination
    }
    environment_variable {
      name  = "DISTRIBUTION_ID"
      value = var.cloudfront_distrubution_id
    }
    environment_variable {
      name  = "APOLLO_KEY"
      value = var.ssm_parameters.APOLLO_KEY
    }
    environment_variable {
      name  = "REACT_APP_API_URL"
      value = "https://${var.api_endpoint}"
    }
    environment_variable {
      name  = "REACT_APP_HOST_URL"
      value = "https://${var.website_endpoint}"
    }
    environment_variable {
      name  = "REACT_APP_KAKAO_KEY"
      value = var.ssm_parameters.KAKAO_KEY
    }
    environment_variable {
      name  = "REACT_APP_S3_BUCKET_ID"
      value = var.client_s3_bucket_id
    }
  }

  tags = {
    Name        = "${var.application_name}-frontend-codebuild-${var.environment}"
    Environment = var.environment
  }
}
```

## ì•± í…ŒìŠ¤í„°

APIì™€ SuperTokens ê·¸ë¦¬ê³  í´ë¼ì´ì–¸íŠ¸ ì•±ê¹Œì§€ ëª¨ë‘ í’€ìŠ¤íƒìœ¼ë¡œ ë™ì‘ì‹œí‚¤ë ¤ë©´ APIì™€ ì›¹ì•±ì„ ë§Œë“¤ì–´ì•¼í•œë‹¤.

### API

ì§€ë‚œ tWILì—ì„œ ë§Œë“  APIë¥¼ ì‚¬ìš©í•˜ì. ë‹¨ authdbëŠ” SuperTokens ì „ìš©ìœ¼ë¡œ ìŠ¤í‚¤ë§ˆë¥¼ ë³€ê²½í•œë‹¤. ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš© docker-compose í™˜ê²½ë³€ìˆ˜ëŠ” ì•„ë˜ì™€ ê°™ì´ ë³€ê²½í•œë‹¤.

```env
DATABASE_URL=postgresql://postgres:password@localhost:5432/apidb?schema=public&connection_limit=5
POSTGRESQL_HOST=postgresqldb
POSTGRESQL_PORT=5432
POSTGRESQL_DATABASE_NAME=authdb
POSTGRESQL_USER=postgres
POSTGRESQL_PASSWORD=password
API_SECRET=m6ailW4fGbCjU25KpJsyM1jWSEJjlZAV
APOLLO_GRAPH_REF=mystack-api@current
AUTH_DOMAIN=http://localhost:3567
API_DOMAIN=http://localhost:8000
WEB_DOMAIN=http://localhost:3000
```

ì§€ë‚œë²ˆ Prisma `db pull`ì„ í†µí•´ ê°™ì€ DBì— SuperTokensì˜ DBë¥¼ ìœ„ì¹˜í–ˆëŠ”ë° ì•„ë¬´ë˜ë„ ì—¬ê¸° í…Œì´ë¸”ì€ ê±´ë“¤ì§€ ì•ŠëŠ” í¸ì´ ì¢‹ê² ë‹¤ê³  íŒë‹¨í•˜ì—¬ ë³„ê°œë¡œ ë¶„ë¦¬í–ˆë‹¤. `apidb`ì™€ `authdb`ë¡œ ê·¸ë¦¬ê³  `override` ì˜µì…˜ì„ í†µí•´ `originalImplementation`ì— post hookì„ ê±¸ì–´ ë°ì´í„° ë™ê¸°í™”ë¥¼ ì‹œì¼œì£¼ê¸°ë¡œ í•œë‹¤.

ê·¸ë¦¬ê³  RecipeëŠ” ì¶”í›„ ì†Œì…œë¡œê·¸ì¸ì„ í—ˆìš©í•˜ê¸° ìœ„í•´ `ThirdParyEmailPassword` ë ˆì‹œí”¼ë¥¼ ì‚¬ìš©í•˜ì˜€ë‹¤.

ë§ˆì§€ë§‰ ê³ ë¯¼ì€ ê°œë°œìë¥¼ ìœ„í•œ Apollo Studioì˜€ë‹¤. SuperTokensëŠ” ì„¸ì…˜ ì¸ì¦ìœ¼ë¡œ ì‚¬ìš©ìë¥¼ íŒë³„í•˜ê¸° ë•Œë¬¸ì— Apollo StudioëŠ” ë‹¤ë¥¸ ë„ë©”ì¸ì´ê¸° ë•Œë¬¸ì— ì¿ í‚¤ ê³µìœ ê°€ ì•ˆëœë‹¤. ì´ê±´ ì–´ì©” ìˆ˜ ì—†ì´ ë°©ì¹˜í•´ë†“ê³  ì•ˆë˜ë©´ ì„œë²„ì— Playgroundë¥¼ ë›°ìš°ëŠ” ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •í• ì§€ ê³ ë¯¼í–ˆì—ˆë‹¤. ìš°ë¦¬ì˜ GraphQLì€ ê¸°ì¡´ì— Authorization Bearer í† í°ìœ¼ë¡œ ì‚¬ìš©ìê°€ ëˆ„êµ¬ì¸ì§€ë¥¼ ì•Œê³  í•´ë‹¹ ì‚¬ìš©ìì— ì í•©í•œ ë°ì´í„°ë¥¼ ê±´ë„¤ì£¼ì—ˆë‹¤. ë”°ë¼ì„œ Variablesì— ì‚¬ìš©ìì˜ IDë¥¼ ë‹´ëŠ”ì¼ì€ ì—†ì—ˆë‹¤. Session ë°©ì‹ìœ¼ë¡œë„ ì¶©ë¶„íˆ ê°€ëŠ¥í–ˆë‹¤. ê·¸ë ‡ì§€ë§Œ ê°œë°œ í™˜ê²½ì´ ë§Œë“¤ì–´ì§€ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê³ ë¯¼ì€ ë¶€ì±„ë¡œ ë‚¨ê²¨ë‘ì—ˆì—ˆëŠ”ë° [apollo explorer](https://www.apollographql.com/docs/graphos/explorer/explorer/)ì˜ Embedded Explorerë¥¼ ë°œê²¬í•˜ì˜€ë‹¤.

ë„ˆë¬´ ë‚˜ì´ìŠ¤í•œ íƒ€ì´ë°ì— ì´ê²ƒì´ ë‚˜ì˜¨ê²Œ ì•„ë‹Œê°€ ì‹¶ì„ ì •ë„ë¡œ ë§ì•„ ë–¨ì–´ì¡Œë‹¤.

ì¦‰ Apollo Studioë¥¼ ìš°ë¦¬ì˜ ì›¹ì•±ì— ì¶”ê°€í•  ìˆ˜ ìˆì—ˆë‹¤. ì›¹ì•±ì„ ìŠ¤íŠœë””ì˜¤ë¡œ ì¸ì¦ë§Œ í•´ì£¼ë©´ ê°œë°œê³„ì •ì´ ìˆëŠ” ì‚¬ëŒë“¤ì€ ì›¹ì•±ì—ì„œ ì„¸ì…˜ì„ ê³µìœ í•˜ë©° ìš”ì²­ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆë‹¤. ì‹¤ì œë¡œ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë´¤ìœ¼ë©° ì„±ê³µ. [Embedding on an arbitrary webpage](https://www.apollographql.com/docs/graphos/explorer/embed-explorer/#embedding-on-an-arbitrary-webpage)

í•˜ë‚˜ì˜ ì»´í¬ë„ŒíŠ¸ë¡œ ì›í•˜ëŠ” ìœ„ì¹˜ì— ë„ìš¸ ìˆ˜ ìˆë‹¤. Embedded ì»´í¬ë„ŒíŠ¸ì´ê¸° ë•Œë¬¸ì— Styled-Componentë¡œ í•˜ìœ„ ìŠ¤íƒ€ì¼ë„ ìˆ˜ì •ì´ ê°€ëŠ¥í•˜ë‹¤. ì´ì œ ì „ì— êµ³ì´ ë³µì¡í•˜ê²Œ ì‚¬ìš©í•˜ë˜ Apollo Clientë„ ê°„ë‹¨í•´ì§€ê³  ì‹¬ì§€ì–´ GraphQL-Requestë„ ê°„ë‹¨íˆ ë³´ë‚¼ ìˆ˜ ìˆìœ¼ë©°, REST í˜¸ì¶œê¹Œì§€ ë³´ì•ˆì´ìŠˆ ì—†ì´ ì‚¬ìš©ì´ ê°€ëŠ¥í•´ì¡Œë‹¤. ì˜ˆì‹œë¡œ, ì–´ë“œë¯¼ í˜ì´ì§€ì— ë‹¬ì•„ì„œ í•„ìš”í•  ë•Œ ê°œë°œìë“¤ì´ í•´ë‹¹ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸í•˜ê³  ì¿¼ë¦¬ë¥¼ ë³´ë‚´ê³  ë°ì´í„°ë¥¼ í™•ì¸í•˜ë©´ ëœë‹¤. ì˜ˆì „ì²˜ëŸ¼ APIë¡œ ë¡œê·¸ì¸í•˜ê³  Authorizationì„ í—¤ë”ì— ì…‹íŒ…í•˜ê³  ì¿¼ë¦¬ë¥¼ ë³´ë‚´ë‹¤ê°€ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë°ì´í„°ë¥¼ ë³´ê¸° ìœ„í•´ í† í°ì„ ì§€ìš°ê³  ìƒˆë¡œ ë¡œê·¸ì¸í•˜ì—¬ í—¤ë”ë¥¼ ì…‹íŒ…í•˜ëŠ” ì´ëŸ° ì‘ì—…ì„ ë°˜ë³µí•  í•„ìš”ê°€ ì—†ì–´ì¡Œë‹¤.

#### Apollo Server v4

ê·¸ë¦¬ê³  ìƒˆë¡œìš´ GA Apollo Serverê°€ ì¶œì‹œë˜ì—ˆë‹¤. v4ì—ì„œëŠ” Expressë„ í¬í•¨ë˜ì—ˆë‹¤. ë”°ë¼ì„œ `apollo-server-express`ë¥¼ ë”ì´ìƒ ì‚¬ìš©í•  í•„ìš”ê°€ ì—†ì–´ì¡Œë‹¤.

Migration ê°€ì´ë“œë¥¼ í†µí•´ v3ì—ì„œ v4ë¡œ ì½”ë“œë¥¼ ëª¨ë‘ ë³€ê²½í•œë‹¤.

```typescript:server_v3.ts
import { ApolloServer } from "apollo-server-express";
```

```typescript:server_v4.ts
import { ApolloServer } from "@apollo/server";
import { expressMiddleware } from "@apollo/server/express4";
import { ApolloServerPluginDrainHttpServer } from "@apollo/server/plugin/drainHttpServer";
import http from "http";
```

ìµœì¢… ì„œë²„ì˜ ì½”ë“œëŠ”

```typescript:server.ts
import { ApolloServer } from "@apollo/server";
import http from "http";
import { expressMiddleware } from "@apollo/server/express4";
import { ApolloServerPluginDrainHttpServer } from "@apollo/server/plugin/drainHttpServer";
import { ApolloServerPluginLandingPageProductionDefault } from "@apollo/server/plugin/landingPage/default";
import { getApp } from "./libs";
import { schema } from "./schema";
import { context, Context } from "./context";

const port = process.env.PORT || "8000";

function getPlugins(httpServer: http.Server) {
  const plugins = [ApolloServerPluginDrainHttpServer({ httpServer })];
  plugins.push(
    ApolloServerPluginLandingPageProductionDefault({
      graphRef: process.env.APOLLO_GRAPH_REF,
      footer: false,
      embed: true,
    }),
  );
  return plugins;
}

export async function runServer() {
  const app = await getApp();
  const httpServer = http.createServer(app);
  const plugins = getPlugins(httpServer);
  const server = new ApolloServer<Context>({
    schema,
    introspection: process.env.NODE_ENV !== "production",
    plugins,
    csrfPrevention: true,
  });
  await server.start();
  app.use("/", expressMiddleware(server, { context }));
  await new Promise<void>((resolve) =>
    httpServer.listen({ port: Number(port) }, resolve),
  );
  console.info(`ğŸš€ GraphQL service ready at http://localhost:${port}`);
}
```

ì´ë ‡ê²Œ ì…‹íŒ…í•œ API ì†ŒìŠ¤ ì½”ë“œëŠ” [API Repository ì»¤ë°‹](https://github.com/eunchurn/supertokens-prisma-graphql-api/tree/f62e884847c2cf0b4d08b748295d67bfb6a87a40)ì„ ì°¸ê³ 

#### Client WebApp (Headless)

ì—¬ê¸°ì„œ HeadlessëŠ” SuperTokensê°€ ì œê³µí•˜ëŠ” DefaultUIë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë°©ì‹ìœ¼ë¡œ ì´ë¦„ì„ ë¶™ì˜€ë‹¤. Material UIì˜ Joy UIë¥¼ ì‚¬ìš©í•´ë³´ì. [ë”°ë¼í•˜ê¸° ì˜ˆì œ](https://mui.com/joy-ui/getting-started/tutorial/)ë¡œ ë¡œê·¸ì¸í¼ì„ ë§Œë“ ë‹¤.

- SignIn

```tsx:SignIn.tsx
import * as React from "react";
import { useColorScheme } from "@mui/joy/styles";
import Sheet from "@mui/joy/Sheet";
import { Box } from "@mui/joy";
import Typography from "@mui/joy/Typography";
import TextField from "@mui/joy/TextField";
import Button from "@mui/joy/Button";
import Link from "@mui/joy/Link";
import { useNavigate } from "react-router-dom";
import { emailPasswordSignIn } from "supertokens-web-js/recipe/thirdpartyemailpassword";

function ModeToggle() {
  const { mode, setMode } = useColorScheme();
  const [mounted, setMounted] = React.useState(false);

  // necessary for server-side rendering
  // because mode is undefined on the server
  React.useEffect(() => {
    setMounted(true);
  }, []);
  if (!mounted) {
    return null;
  }

  return (
    <Button
      variant="outlined"
      onClick={() => {
        setMode(mode === "light" ? "dark" : "light");
      }}
    >
      {mode === "light" ? "Turn dark" : "Turn light"}
    </Button>
  );
}

interface State {
  email: string;
  password: string;
}

const initState: State = {
  email: "",
  password: "",
};
export function Signin() {
  const [state, setState] = React.useState<State>(initState);
  const navigate = useNavigate();
  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setState({ ...state, [e.target.name]: e.target.value });
  };
  const signIn = React.useCallback(() => {
    emailPasswordSignIn({
      formFields: [
        { id: "email", value: state.email },
        { id: "password", value: state.password },
      ],
    }).then(() => navigate("/"));
  }, [navigate, state.email, state.password]);
  return (
    <Box
      sx={{
        width: "100vw",
        height: "95vh",
        display: "flex",
        justifyContent: "center",
        alignItems: "center",
      }}
    >
      <main style={{ maxWidth: "600px" }}>
        <ModeToggle />
        <Sheet
          sx={{
            width: 300,
            mx: "auto", // margin left & right
            my: 4, // margin top & botom
            py: 3, // padding top & bottom
            px: 2, // padding left & right
            display: "flex",
            flexDirection: "column",
            gap: 2,
            borderRadius: "sm",
            boxShadow: "md",
          }}
          variant="outlined"
        >
          <div>
            <Typography level="h4" component="h1">
              <b>Welcome!</b>
            </Typography>
            <Typography level="body2">Sign in to continue.</Typography>
          </div>
          <TextField
            // html input attribute
            name="email"
            type="email"
            placeholder="johndoe@email.com"
            // pass down to FormLabel as children
            label="Email"
            onChange={handleChange}
          />
          <TextField
            name="password"
            type="password"
            placeholder="password"
            label="Password"
            onChange={handleChange}
          />
          <Button sx={{ mt: 1 /* margin top */ }} onClick={signIn}>
            Log in
          </Button>
          <Typography
            endDecorator={<Link href="/signup">Sign up</Link>}
            fontSize="sm"
            sx={{ alignSelf: "center" }}
          >
            Don&apos;t have an account?
          </Typography>
        </Sheet>
      </main>
    </Box>
  );
}
```

![signin](/static/images/2022/11/signin-form.png)

- SignUp

íšŒì›ê°€ì…í¼ë„ ê°„ë‹¨íˆ ìˆ˜ì •í•˜ì—¬ ë§Œë“ ë‹¤.

```tsx:SignUp.tsx
import * as React from "react";
import { useColorScheme } from "@mui/joy/styles";
import Sheet from "@mui/joy/Sheet";
import { Box } from "@mui/joy";
import Typography from "@mui/joy/Typography";
import TextField from "@mui/joy/TextField";
import Button from "@mui/joy/Button";
import Link from "@mui/joy/Link";
import { useNavigate } from "react-router-dom";
import { emailPasswordSignUp } from "supertokens-web-js/recipe/thirdpartyemailpassword";

function ModeToggle() {
  const { mode, setMode } = useColorScheme();
  const [mounted, setMounted] = React.useState(false);
  // necessary for server-side rendering
  // because mode is undefined on the server
  React.useEffect(() => {
    setMounted(true);
  }, []);
  if (!mounted) {
    return null;
  }

  return (
    <Button
      variant="outlined"
      onClick={() => {
        setMode(mode === "light" ? "dark" : "light");
      }}
    >
      {mode === "light" ? "Turn dark" : "Turn light"}
    </Button>
  );
}

interface State {
  email: string;
  password: string;
  newPassword: string;
}

const initState: State = {
  email: "",
  password: "",
  newPassword: "",
};

export function Signup() {
  const [state, setState] = React.useState<State>(initState);
  const navigate = useNavigate();
  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setState({ ...state, [e.target.name]: e.target.value });
  };
  const signUp = React.useCallback(() => {
    emailPasswordSignUp({
      formFields: [
        { id: "email", value: state.email },
        { id: "password", value: state.password },
      ],
    }).then(() => {
      navigate("/");
    });
  }, [navigate, state.email, state.password]);
  return (
    <Box
      sx={{
        width: "100vw",
        height: "95vh",
        display: "flex",
        justifyContent: "center",
        alignItems: "center",
      }}
    >
      <main style={{ maxWidth: "600px" }}>
        <ModeToggle />
        <Sheet
          sx={{
            width: 300,
            mx: "auto", // margin left & right
            my: 4, // margin top & botom
            py: 3, // padding top & bottom
            px: 2, // padding left & right
            display: "flex",
            flexDirection: "column",
            gap: 2,
            borderRadius: "sm",
            boxShadow: "md",
          }}
          variant="outlined"
        >
          <div>
            <Typography level="h4" component="h1">
              <b>Welcome!</b>
            </Typography>
            <Typography level="body2">Sign up to continue.</Typography>
          </div>
          <TextField
            // html input attribute
            name="email"
            type="email"
            placeholder="johndoe@email.com"
            // pass down to FormLabel as children
            label="Email"
            onChange={handleChange}
          />
          <TextField
            name="password"
            type="password"
            placeholder="password"
            label="Password"
            onChange={handleChange}
          />
          <TextField
            name="newPassword"
            type="password"
            placeholder="password"
            label="Repeat Password"
            onChange={handleChange}
          />
          <Button
            sx={{ mt: 1 /* margin top */ }}
            disabled={state.newPassword !== state.password}
            onClick={signUp}
          >
            Join
          </Button>
          <Typography
            endDecorator={<Link href="/signin">Sign in</Link>}
            fontSize="sm"
            sx={{ alignSelf: "center" }}
          >
            Have an account?
          </Typography>
        </Sheet>
      </main>
    </Box>
  );
}
```

![signup](/static/images/2022/11/signup-form.png)

- ë¡œê·¸ì¸ ì„±ê³µ

![success](/static/images/2022/11/success-graphql.png)

Apollo ServerëŠ” Contextì˜ Sessionì„ í†µí•´ ì‚¬ìš©ìì˜ IDë¥¼ ê°€ì ¸ì™€ì„œ í•„ìš”í•œ ì¿¼ë¦¬ë“¤ì„ ë§Œë“¤ì–´ë‚´ë©´ ëœë‹¤. ë‹¹ì—°íˆ ì§€ë‚œ tWILì—ì„œ ì ì—ˆë˜ Overrideí•¨ìˆ˜ë“¤ì´ ë™ì‘í•´ì•¼í•œë‹¤. PreHook, PostHook ëª¨ë‘ ê°œë°œìê°€ ì›í•˜ëŠ” ì…ë§›ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆë‹¤.

```typescript:supertokens.ts
supertokens.init({
  recipeList: [
    ThirdParyEmailPassword.init({
      providers: [
        // ...omitted
      ],
      override: {
        functions: (originalImplementation) => {
          return {
            ...originalImplementation,
            async emailPasswordSignIn(input) {
              const signinUser =
                await originalImplementation.emailPasswordSignIn(input);
              const { status } = signinUser;
              if (status === "OK") {
                const {
                  user: { email, id },
                } = signinUser;
                await prisma.accessLog.create({
                  data: {
                    user: { connect: { authId: id } },
                    email,
                    accessType: AccessType.SIGNIN,
                  },
                });
              }
              return signinUser;
            },
            async emailPasswordSignUp(input) {
              const signupUser =
                await originalImplementation.emailPasswordSignUp(input);
              const { status } = signupUser;
              if (status === "OK") {
                const {
                  user: { email, id },
                } = signupUser;
                await prisma.user.create({ data: { email, authId: id } });
                await prisma.accessLog.create({
                  data: {
                    user: { connect: { authId: id } },
                    email,
                    accessType: AccessType.SIGNUP,
                  },
                });
              }

              return signupUser;
            },
          };
        },
      },
    })
  ]
})
```

ì´ì œ ë‚˜ì¤‘ì— ë¦¬íŒ©í† ë§ í•  ë•Œ ë³„ë„ì˜ hook í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ í…ŒìŠ¤íŠ¸ ì½”ë“œì™€ í•¨ê»˜ ë¶™ì—¬ì•¼ í•œë‹¤. í˜„ì¬ëŠ” ë™ì‘í•˜ëŠ” ëŒ€ë¡œ ê·¸ëŒ€ë¡œ ë‘ê³  í´ë¼ì´ì–¸íŠ¸ ì‘ì—…ì— ì—´ì„ ì˜¬ë ¤í– í•œë‹¤.

ì´ì œ Terraformìœ¼ë¡œ APIì™€ Auth ECS í´ëŸ¬ìŠ¤í„°ì— ì„œë¹„ìŠ¤ë¡œ ë°°í¬í•˜ê³  Clientë¥¼ CDNì— ë°°í¬í•˜ê³  í…ŒìŠ¤íŠ¸í•´ë³´ë©´ ëœë‹¤. ê°œì¸ AWS ê³„ì •ì„ ê°€ì§€ê³  ìˆë‹¤ë©´ í…ŒìŠ¤íŠ¸ í•´ë³´ë©´ ë  ê²ƒ ê°™ë‹¤. ì´ì œ Cognito ì§€ì˜¥ì—ì„œ í•´ë°©ì´ ëœ ê²ƒ ê°™ë‹¤.

### Apollo Explorer

ì´ì œ ì•„í´ë¡œ Explorerë¥¼ ì„¤ì¹˜í•´ë³´ì `use-deep-compare-effect`ê°€ peerDepsì— ì¶”ê°€ë˜ì§€ ì•Šì€ ê²ƒ ê°™ë‹¤. ê°™ì´ ì„¤ì¹˜í•œë‹¤.

```
yarn add @apollo/explorer use-deep-compare-effect
```

`Route`ì— ì´ ì»´í¬ë„ŒíŠ¸ë¥¼ ì¶”ê°€í•˜ë©´

```tsx:App.tsx showLineNumbers
import { EmbeddedExplorer } from "./Explorer";

function App() {
  return (
    <RootProvider>
      <CssBaseline />
      <Routes>
        <Route path="/" element={<Home />} />
        <Route path="signin" element={<Signin />} />
        <Route path="signup/*" element={<Signup />} />
        <Route path="explorer/*" element={<EmbeddedExplorer />} />
      </Routes>
    </RootProvider>
  );
}
```

ê·¸ë¦¬ê³  `ApolloExplorer`ëŠ” heightê°€ ì´ìƒí•˜ê²Œ ì„¤ì •ë˜ì–´ ìˆì–´ì„œ styledë¡œ ì „ì²´ë¡œ í™•ì¥ì‹œì¼œì¤€ë‹¤.

```tsx:Explorer.tsx
import { ApolloExplorer } from "@apollo/explorer/react";
import { styled } from "@mui/joy";

const StyledApolloExplorer = styled(ApolloExplorer)(() => ({
  width: "100%",
  height: "100vh",
  overflowY: "hidden",
}));

export function EmbeddedExplorer() {
  return (
    <StyledApolloExplorer
      graphRef="builderhub-api@current"
      persistExplorerState
      includeCookies
      initialState={{
        document: `query ExampleQuery {
  getMe {
    authId
  }
}
`,
        variables: {},
        headers: {},
        displayOptions: {
          showHeadersAndEnvVars: true,
          docsPanelState: "open",
          theme: "light",
        },
      }}
    />
  );
}
```

`http://localhost:3000/explorer`ì— ì ‘ì†í•˜ë©´ ìµœì´ˆ Apollo Studioì— ì¸ì¦ì²˜ë¦¬ í•´ì£¼ë©´ Apollo Exporerê°€ ëœ¨ê³  `getMe` ì¿¼ë¦¬ ìš”ì²­ì€ ì •ìƒ.

![request](/static/images/2022/11/request.png)

ê·¸ë¦¬ê³  ì„¸ì…˜ì€ ì¿ í‚¤ì— ê·¸ëŒ€ë¡œ ë‹´ê²¨ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.

![session](/static/images/2022/11/apollo-explorer.png)

Client ì•± ì „ì²´ ì†ŒìŠ¤ ì½”ë“œëŠ” [Client WebAPP Repository](https://github.com/eunchurn/supertokens-client-headless) ì—¬ê¸°ì— ê³µê°œí•œë‹¤.

ë‹¤ìŒ ì£¼ëŠ” ThirdParty ì†Œì…œ íšŒì›ê°€ì… ë¡œê·¸ì¸ì„ êµ¬í˜„í•´ë³´ê³  Admin ê¹Œì§€ ì ìš©í•˜ë ¤ê³  í•œë‹¤. ê·¸ë¦¬ê³  ì†ë„ë¥¼ ë¶™ì—¬ ë‚˜ë¨¸ì§€ ë¯¸ë¤„ë‘ì—ˆë˜ ì´ë©”ì¼ ì°¾ê¸°, ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° ëª¨ë‘ êµ¬í˜„í•  ì˜ˆì •ì´ë‹¤.

ê·¸ë¦¬ê³  SuperTokensëŠ” DB Statefull ì„¸ì…˜ì´ê¸° ë•Œë¬¸ì— Prisma Schemaì˜ Userë§Œ ë™ê¸°í™” ë¼ëŠ” ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¥¼ ë§Œë“ ë‹¤ë©´ ê´œì°®ì„ ê²ƒ ê°™ë‹¤ëŠ” ìƒê°ì„ í–ˆë‹¤. ì´ ìŠ¤í‚¤ë§ˆë§Œ ë–¼ì–´ë‚´ì„œ ë³„ë„ì˜ ì¸ì¦ë§Œ ê´€ë¦¬í•˜ëŠ” ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¥¼ êµ¬í˜„í•´ë„ ì¢‹ì„ ê²ƒ ê°™ë‹¤.

## Appendix

### A. VSCODE ì ìœ ìœ¨ ë¬¸ì œ

ì§€ë‚œ ì£¼ì˜€ì„ ê²ƒ ê°™ë‹¤. visual studio codeê°€ ì—…ë°ì´íŠ¸ ëœ ì´í›„ í•œ VSCODE í”„ë¡œì íŠ¸ ì°½ë§ˆë‹¤ CPU ì ìœ ìœ¨ì´ 200%ë¥¼ ì¹˜ê³  ìˆì—ˆë‹¤(feat. `htop`). ëª‡ê°œì˜ ì˜ì‹¬ë˜ëŠ” Extensionì„ disabled í•´ë„ í•´ê²°ì´ ì•ˆë˜ì—ˆê³ , `Developer: Show Running Extensions`ë¡œ ë¡œê¹…í•´ë´ë„ ë¬¸ì œê°€ í•´ê²°ë˜ì§€ ì•Šì•˜ë‹¤. ì‹¬ì§€ì–´ Visual Studio Code Insidersê¹Œì§€ ì„¤ì¹˜í•´ë³´ê³  í–ˆì§€ë§Œ ì—¬ì „íˆ ì¦ìƒì€ ê·¸ëŒ€ë¡œ TypeScript ì¸í…”ë¦¬ì„¼ìŠ¤ ê¸°ëŠ¥ë„ ë™ì‘í•˜ì§€ ì•Šì•˜ë‹¤. PC ì¬ë¶€íŒ…ì„ ì—¬ëŸ¬ë²ˆ í•´ë„ ë‚˜ì•„ì§€ì§€ ì•Šì•„ì„œ ì˜¤ê¸°ë¥¼ ê°€ì§€ê³  `htop`ì„ ì¼œê³  ìµìŠ¤í…ì…˜ì„ í•˜ë‚˜ì”© ì œê±°í•˜ê¸° ì‹œì‘í–ˆë‹¤.

ì›ì¸: `Setting Sync`

VSCODE ìì²´ì ìœ¼ë¡œ Setting Syncê°€ ë™ì‘í•˜ê¸° ë•Œë¬¸ì¸ì§€ ì•Œ ìˆ˜ ì—†ì§€ë§Œ, ì´ ë…€ì„ì´ 200% ì ìœ ìœ¨ì„ ë§Œë“¤ì–´ë‚´ê³  ìˆì—ˆë‹¤. ëŒ€ëµ 5ì‹œê°„ ì‚½ì§ˆ ëì— ì•Œì•„ëƒˆìœ¼ë©° ìœ ìš©í•˜ê²Œ ì˜ ì“°ë˜ ì´ ìµìŠ¤í…ì…˜ì€ ì´ì œ ì—­ì‚¬ ì†ìœ¼ë¡œ...

## B. Terraform forcing replacement ì´ìŠˆ

ë§¤ë²ˆ ë°°í¬í•  ë•Œ ë§ˆë‹¤ Auth ì„œë¹„ìŠ¤ë¥¼ ê°•ì œë¡œ Replacement í•˜ëŠ” ì´ìŠˆê°€ ìˆë‹¤.

[ì´ìŠˆ ë§í¬](https://github.com/hashicorp/terraform-provider-aws/issues/11526)

ì´ëŸ° ê²½ìš° ë¼ì´í”„ì‚¬ì´í´ì„ ì§€ì •í•´ì„œ ë³€ê²½ì ì„ ë¬´ì‹œí•˜ë„ë¡ ì¼ë‹¨ ì„¤ì •í•´ë‘”ë‹¤.

```hcl
  lifecycle {
    ignore_changes = [
      cluster,
      iam_role,
      id,
      platform_version
    ]
  }
```
