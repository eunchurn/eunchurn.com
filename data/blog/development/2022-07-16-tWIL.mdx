---
date: "2022-07-17"
title: "tWIL 2022.07 2ì£¼ì°¨"
draft: false
summary: "This week I learned"
featured: /static/images/2022/06/tWIL.jpg
categories:
  - development
tags:
  - development
  - Amplify
  - Redux
  - ReduxToolkit
  - RTK
  - RTKQ
  - API Gateway
  - TypeScript
  - GraphQL-codegen
  - Serverless
  - Lambda
  - CI
  - CD
  - React
  - Cognito
---

ì´ë²ˆ ì£¼ëŠ” API ë³´ì•ˆê³¼ ê´€ë ¨í•˜ì—¬ ì‹œí–‰ì°©ì˜¤ë¥¼ ê²ªì—ˆë‹¤. ë¬¸ì„œë¥¼ ì°¾ì•„ë³´ê³  ë‹¤ì‹œ ìµíˆëŠ”ë° ì‹œê°„ì„ ë§ì´ ì“´ ê²ƒ ê°™ë‹¤. í•˜ì§€ë§Œ ì´ ë³´ì•ˆê³¼ ì¸ì¦ ë¶€ë¶„ì€ ì•±ê³¼ ì¸í”„ë¼ë¥¼ ë¹Œë“œì—…í•˜ëŠ”ë° ìˆì–´ì„œ ë§¤ìš° ì¤‘ìš”í•˜ê¸° ë•Œë¬¸ì—, ì‹œê°„ê³¼ ê³µì„ ë§ì´ ë“¤ì—¬ì•¼í•˜ëŠ” ê²ƒì€ ë§ëŠ” ê²ƒ ê°™ë‹¤. ì–¸ì  ê°€ëŠ” k8së¡œ ì´ ëª¨ë“  ê²ƒì„ ë¹Œë“œí•´ë³¼ ìˆ˜ ìˆì„ì§€ ê¶ê¸ˆí•´ì§€ê¸°ë„ í–ˆë‹¤.

## Apollo server [CSRF](https://www.apollographql.com/docs/router/configuration/csrf/)

ì‘ì—…ì¤‘ì¸ Clientì•±ì€ Amplifyë¥¼ ì ìš©í•˜ê³  ìˆë‹¤. Cognito Authì™€ Storage ê·¸ë¦¬ê³  MSAë¥¼ Lambdaì™€ API Gatewayë¡œ êµ¬ì¶•í•˜ê¸° ìœ„í•¨ì´ë‹¤. ê·¸ë¦¬ê³  ë©”ì¸ RDSë¥¼ ì‚¬ìš©í•˜ëŠ” GraphQL APIëŠ” Amplifyì˜ ìƒì‚°ì„± í•œê³„ë¡œ ì¸í•´ [AWS Copilot](https://docs.aws.amazon.com/ko_kr/AmazonECS/latest/developerguide/getting-started-aws-copilot-cli.html)ë¡œ ECSì— ë°°í¬í•˜ì˜€ë‹¤. Copilotì€ Amplifyê¹Œì§€ IaSë¡œ ê´€ë¦¬í•˜ì§€ ëª»í•˜ê¸° ë•Œë¬¸ì— DevOps ê´€ë¦¬ì ì€ í¬ê²Œ 2êµ°ë°(Copilot, Amplify)ë¡œ ë³¼ ìˆ˜ ìˆë‹¤. Amplifyì˜ ì¥ì ì€ í™œìš©í•˜ê¸° ë‚˜ë¦„ ê´œì°®ì€ë©´ì´ ìˆì–´ì„œ, Cognito, S3, API Gateway, Lambdaë¥¼ í•œê³³ì—ì„œ ê´€ë¦¬í•  ìˆ˜ ìˆìœ¼ë©°, Copilotì€ RDS, ECS, VPC, Target Group, ALB, System Manager, Secret Managerë“±ì„ ê´€ë¦¬í•œë‹¤.

Amplify Storageì—ì„œ íŒŒì¼ ì „ì†¡ì„ í•œ í›„ Protect, Privateìœ¼ë¡œ ì„¤ì •ëœ íŒŒì¼ë“¤ì€ Cognito identity poolì˜ IDë¡œ ìƒì„±ëœë‹¤. ê°€ë” Third party APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ë¥¸ OSSë¥¼ ì‚¬ìš©í•  ê²½ìš° ECSë¡œ ë°°í¬ëœ APIì—ì„œ ì´ íŒŒì¼ë“¤ì„ ì²˜ë¦¬í•´ì•¼í•  ê²½ìš°ê°€ ìˆë‹¤. ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ì—­ì´ ë‹¤ë¥¸ ê³³ì´ë¼ GraphQL APIì— Upload ì„¤ì •ì´ ë¶ˆê°€í”¼í–ˆë‹¤.

GraphQLì€ ì•ì„œì„œ ì´ì•¼ê¸°í•œ ë°”ì™€ ê°™ì´. Nexus GraphQLê³¼ Apollo Server(`apollo-server-express`) ê·¸ë¦¬ê³  Expressë¥¼ ì‚¬ìš©í•œë‹¤. ì¦‰, express ë¯¸ë“¤ì›¨ì–´ë¡œ Apollo serverë¥¼ êµ¬ë™ì¤‘ì´ë©°, ì—…ë¡œë“œ ì„¤ì •ì€ `app`ì—ì„œ ë¯¸ë“¤ì›¨ì–´ ì„¤ì •ì„ í•œë‹¤.

```typescript
import express, { Response } from "express";
import { graphqlUploadExpress } from "graphql-upload";

const app = express();
app.use(graphqlUploadExpress());
// omitted

export { app };
```

Apollo serverëŠ” 3.7ë²„ì „ ì´í›„ë¶€í„° ì—…ë¡œë“œë¥¼ ì‚¬ìš©í•  ë•Œ ì„œë²„ ìì›ì„ ì ‘ê·¼ì œì–´ë¥¼ í•˜ë„ë¡ [CSRF, Cross-Site Request Forgery](https://www.apollographql.com/docs/router/configuration/csrf/) `csrfPrevention`ì„ í•„ìˆ˜ë¡œ ì„¤ì • í•˜ë„ë¡ [ê°€ì´ë“œ](https://www.apollographql.com/docs/apollo-server/security/cors/)í•œë‹¤.

![apollo-server-cors](/static/images/2022/07/apollo-server-cors.png)

```typescript
import { ApolloServer } from "apollo-server-express";
import { app } from "./app";

const server = new ApolloServer({
  schema,
  context,
  introspection: process.env.NODE_ENV !== "production",
  // omitted
  csrfPrevention: true,
  cache: "bounded",
});
// omitted

export async function runServer() {
  await server.start();
  server.applyMiddleware({ app, path: "/" });
  await new Promise<void>((resolve) => app.listen(Number(port), resolve));
  logger.info(`ğŸš€ GraphQL service ready at http://localhost:${port}${server.graphqlPath}`);
}
```

í´ë¼ì´ì–¸íŠ¸ì—ì„œ `ApolloLink`ëŠ” `apollo-require-preflight`ì„¤ì •ì„ í•´ì£¼ì–´ì•¼ `File` ê°ì²´ê°€ `readableStream`ê³¼ í•¨ê»˜ APIë¡œ ë„˜ì–´ì˜¨ë‹¤.

```typescript
const httpLink = createUploadLink({
  uri,
  headers: { "apollo-require-preflight": true },
});
```

## Apollo Client with Hook

![apollo-server](https://www.apollographql.com/docs/c5e2d4db4b0b5568a87ebf082ffe79e6/frontend_backend_diagram.svg)

[Apollo client(React)](https://www.apollographql.com/docs/react)ì™€ [Apollo server](https://www.apollographql.com/docs/apollo-server) ê·¸ë¦¬ê³  [Apollo studio](https://www.apollographql.com/docs/studio)ëŠ” ì•„ë˜ ê·¸ë¦¼ê³¼ ê°™ì´ ì—°ê²°í•˜ì—¬ ì‚¬ìš©í•´ì™”ë‹¤.

GraphQL schemaì˜ Introspectionì„ í—ˆìš©í•˜ì§€ ì•ŠëŠ” ê²½ìš°, ê·¸ë¦¬ê³  Apollo studioë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²½ìš° í´ë¼ì´ì–¸íŠ¸ê°€ ì‚¬ìš©í•  ìŠ¤í‚¤ë§ˆ SDLíŒŒì¼ì„ ê°œë°œìë¼ë¦¬ ì£¼ê³  ë°›ê±°ë‚˜ í–ˆì–´ì•¼ í–ˆë‚˜. ì´ì „ì—ëŠ” Introspection queryë¥¼ í—ˆìš©í–ˆì—ˆë‹¤. ëª¨ë“  ì†ŒìŠ¤ì—ì„œ ì´ ìŠ¤í‚¤ë§ˆë¥¼ ê³µê°œí•œë‹¤ëŠ” ê²ƒì´ êº¼ë¦¼ì¹™í–ˆëŠ”ë°, Apollo server v3ì—ì„œ Apollo studioë¥¼ sandboxí˜•íƒœë¡œ ì œê³µí•˜ë©´ì„œ sandbox í˜•íƒœê°€ ì•„ë‹Œ studioë„ ì–´ëŠì •ë„ ì´í•´í•˜ê²Œ ë˜ì—ˆë‹¤. íŠ¹íˆ [@apollo/rover](https://www.apollographql.com/docs/rover)ë¥¼ í†µí•´ ìŠ¤í‚¤ë§ˆë¥¼ ì˜®ê¸°ê³ , Apollo serverëŠ” studioë¡œ Operationë“¤ì˜ [metric](https://www.apollographql.com/docs/studio/metrics/usage-reporting/)ì„ ë³´ë‚´ì£¼ëŠ” í˜•íƒœë¡œ Apollo studioë¥¼ ì‚¬ìš©í•˜ë©° í¸ë¦¬í•¨ì„ ëŠë¼ê³  ìˆì—ˆë‹¤. ì—¬ê¸°ì— [Apollo Federation](https://www.apollographql.com/docs/federation/)ì´ ë‚˜ì˜¤ê²Œ ë˜ë©´ì„œ [supergraph](https://www.apollographql.com/docs/rover/commands/supergraphs)ì™€ [subgraph](https://www.apollographql.com/docs/rover/commands/subgraphs)ë¥¼ ì ìš©í•˜ì—¬ Open source í˜•íƒœë¡œ êµ¬ì¶•í•œ ì„œë²„ í˜¹ì€ ì»¨í…Œì´ë„ˆì™€ AppSyncë“± ì—¬ëŸ¬ í´ë¼ìš°ë“œì—ì„œ ë§Œë“  GraphQL ì„œë²„ë„ Studioì—ì„œ í†µí•©í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ subgraphë¥¼ [composition](https://www.apollographql.com/docs/rover/commands/supergraphs#setting-a-composition-version) í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆë‹¤.

![apollo-client](/static/images/2022/07/apollo-client.svg)

Apollo clientë¥¼ ì‚¬ìš©í•˜ëŠ” ë¬˜ë¯¸ëŠ” [GraphQL-codegen](https://www.graphql-code-generator.com/) í”ŒëŸ¬ê·¸ì¸ ì¤‘ì— [TypeScript React Apollo](https://www.graphql-code-generator.com/plugins/typescript/typescript-react-apollo) í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í•˜ë©°, ìš°ë¦¬ê°€ ì‚¬ìš©í•  ëª¨ë“  GraphQL operationì„ React hooksë¡œ ë§Œë“¤ì–´ ì¤Œìœ¼ë¡œì¨ TypeScript íƒ€ì…ë§Œ ë§Œë“¤ì–´ `useQuery`, `useLazyQuery`, `useMutation`ì„ ë§Œë“œëŠ” ë°©ë²•ë³´ë‹¤ `use{Operation Name}Query`, `use{Operation Name}LazyQuery`, `use{Operation Name}Mutation`ë“±ì˜ hookì„ ë§Œë“¤ì–´ ì¤Œìœ¼ë¡œ í”„ë¡ íŠ¸ê°œë°œì ìƒì‚°ì„±ì— ë§ì€ ê¸°ì—¬ë¥¼ í•œë‹¤.

### Authentication/Authorization

ì§€ê¸ˆê¹Œì§€ Nodejsë¡œ [Nexus GraphQL](https://nexusjs.org/)ê³¼ Apollo serverë¡œ GraphQL APIë¥¼ ë§Œë“¤ì–´ ì˜¤ë©´ì„œ `Context`ì— `request.headers.authorization`ì— ë‹´ê¸´ í† í°ìœ¼ë¡œ ì¸ì¦ ë° ì¸ê°€ë¥¼ ì²˜ë¦¬í•˜ê³  ì´ í† í°ì— ë‹´ê¸´ Roleì— ì˜í•´ ê° GraphQLì˜ fieldì— [`fieldAuthorzation`](https://nexusjs.org/docs/plugins/field-authorize#field-authorize) í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í•˜ì—¬, ì¸ê°€(authorization)ê¶Œí•œì„ ë¶€ì—¬í•˜ì˜€ë‹¤. ì´ì •ë„ë§Œ í•´ë„ ë¬¸ì œê°€ ì—†ì§€ ì•Šì„ê¹Œ ìƒê°í–ˆì§€ë§Œ, ì´ APIëŠ” ëª¨ë“  ì†ŒìŠ¤ì—ê²Œ ì—´ë ¤ìˆê³  ëˆ„êµ¬ë“  ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ìƒíƒœì´ê¸° ë•Œë¬¸ì— ë¬¸ì œê°€ ë  ìˆ˜ ìˆë‹¤. ë¶„ëª… ë¡œê·¸ì¸ì´ë‚˜ íšŒì›ê°€ì… ê·¸ë¦¬ê³  ì´ë©”ì¼ ì¤‘ë³µ ì²´í¬ì™€ ê°™ì€ publicìœ¼ë¡œ ê³µê°œí•´ì•¼í•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ë„ ë¬¸ì œê°€ ë  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì•Œì•˜ë‹¤. ALBë‚˜ API Gatewayë¥¼ ì‚¬ìš©í•  ê²½ìš° ë””ë„ìŠ¤ ê³µê²©ì€ ë§‰ì•„ì£¼ê¸´ í•˜ì§€ë§Œ ì›ì²œì ìœ¼ë¡œ ë§‰ì•„ ë†“ì€ ìƒíƒœì—¬ì•¼ ì–´ë–¤ ì•…ì˜ì ì¸ ê³µê²©ì—ì„œë„ APIì˜ ìì›ì„ ë‚´ì–´ì£¼ì§€ ì•Šì„ ê²ƒì´ë‹¤. [Unauthenticated rule](https://docs.aws.amazon.com/cognito/latest/developerguide/identity-pools.html)ì— ì˜í•œ API ì ‘ê·¼ì„ ì•Œì•„ë³´ì•˜ë‹¤.

### Apollo client link with Amplify `Auth`

ì‹œì‘í•˜ê¸°ì „ì— Amplifyë¡œ ì„¤ì •í•œ backendì˜ Authë¥¼ ì‚¬ìš©í•˜ë ¤ë©´, ì¼ë‹¨ ì•±ì´ ë‹¨ìˆœí•œ ê²½ìš° `Authenticator`ì˜ `Provider`ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤. AmplifyëŠ” ì •ë§ ë„ˆë¬´ë„ í¸í•˜ê²Œ ì‚¬ìš©ì ë¡œê·¸ì¸ê´€ë ¨ UIë¥¼ ëª¨ë‘ ì œê³µí•œë‹¤. í•˜ì§€ë§Œ ì´ ë§ì€ ì»¤ìŠ¤í…€í•˜ê²Œ ë°”ê¾¸ê¸°ëŠ” ì–´ë µë‹¤ëŠ” ë§ì´ ëœë‹¤. ê·¸ë¦¬ê³  Amplify GraphQL APIë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´, ê³¨ì¹˜ì•„í”ˆ ì‘ì—…ë“¤ì„ ì ìš©í•´ì•¼í•œë‹¤. ì—¬ê¸°ì„œëŠ” Apollo Serverì— Apollo Linkë¥¼ ë§Œë“œëŠ” ì‘ì—…ì„ ì‹œë„í•´ë³´ì•˜ë‹¤.

Apollo clientì— async í˜•íƒœì˜ `setContext`ë§í¬ë¥¼ ë§Œë“¤ ê²½ìš°ê°€ ìˆì—ˆë‹¤. ì™¸ë¶€ ê²½ë¡œ fetchí›„ headerê°’ì„ ì„¤ì •í•˜ëŠ” ê²½ìš°ê°€ ìˆëŠ”ë° ë‹¤í–‰ì´ `setContext`ì˜ `setter`ì— Promiseë¥¼ í—ˆìš©í•˜ì—¬ ì‚¬ìš©í•˜ë©´ ë˜ì§€ë§Œ, Amplifyë¥¼ ì´ìš©í•œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ API ë¡œë“œë°¸ëŸ°ì„œ ì¸ì¦ì„ í†µê³¼í•˜ê¸° ìœ„í•œ í´ë¼ì´ì–¸íŠ¸ ë§í¬ ì‘ì—…ì´ í•„ìš”í–ˆë‹¤.

```typescript
import { setContext } from "@apollo/client/link/context";
import { Auth } from "aws-amplify";

const asyncAuthLink = setContext(
  () =>
    new Promise((resolve, reject) => {
      Auth.currentSession()
        .then((token) => {
          const accessToken = token.getAccessToken();
          resolve({
            headers: { authorization: `${accessToken.getJwtToken()}` },
          });
        })
        .catch(reject);
    })
);
```

![apollo-auth-link](/static/images/2022/07/apollo-amplify-auth-link.svg)

ì—¬ê¸°ì„œ Amplifyì˜ UI ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì¸ [Hub](https://docs.amplify.aws/console/uibuilder/eventhandling/)ë¥¼ ì‚¬ìš©í•œë‹¤. Amplifyì—ì„œ ì‚¬ìš©í•˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ë°›ì„ ìˆ˜ ìˆê³ , `auth` ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ê²½ìš° ì´ë²¤íŠ¸ ì¡°ê±´ì— ë”°ë¼ Apollo Clientì˜ clientì˜ linkë¥¼ ë³€ê²½í•˜ë„ë¡ í•œë‹¤. ì—¬ê¸°ì„œëŠ” ë¡œê·¸ì¸ í–ˆì„ ë•Œì™€, ë¡œê·¸ì•„ì›ƒí•œ ê²½ìš°ì˜ ì¡°ê±´ìœ¼ë¡œ ë‚˜ëˆ„ì–´ `addListeners`í•¨ìˆ˜ë¥¼ ë§Œë“ ë‹¤.

```typescript
let amplifyAuthLink: AuthLink | null = null;
/**
 * It listens for events from the Amplify Auth library and updates the `amplifyAuthLink` variable
 * accordingly. Add Hub auth listeners, to detect sign-in/out.
 * @param {string} region - The AWS region you're using.
 * @param {string} url - The URL of the GraphQL API.
 * @returns A function that takes an object with a payload property and returns nothing.
 */
export const addListeners = (region: string, url: string) => {
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const handleAuthEvents = ({ payload }: { payload: any }) => {
    switch (payload.event) {
      case "signIn":
        amplifyAuthLink = createCognitoAuthLink(payload.data.signInUserSession, region, url);
        break;
      case "signOut":
        amplifyAuthLink = createIamAuthLink(region, url);
        break;
      case "configured":
      case "signIn_failure":
      case "signUp":
      default:
        break;
    }
  };
  Hub.listen("auth", handleAuthEvents);
  return handleAuthEvents;
};
```

ë§í¬ê°€ ëŠì–´ì§ˆ ë•Œ ì œê±°í•  ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜ `removeListeners`ëŠ”

```typescript
/**
 * It removes a listener from the Hub
 * @param {HubCallback} handler - The function that will be called when the event is emitted.
 */
export const removeListeners = (handler: HubCallback) => Hub.remove("auth", handler);
```

#### Apollo client ìƒì„±

Apollo clientëŠ” ì—¬ëŸ¬ ë§í¬ ë§ˆì§€ë§‰ì— `httpLink`ë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” íŒŒì¼ ì—…ë¡œë“œë„ ë¯¸ë“¤ì›¨ì–´ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ `uploadLink`ë¥¼ httpLinkë¡œ ì‚¬ìš©í•˜ê³ (httpLinkê°€ í¬í•¨ë˜ì–´ ìˆìŒ, ë°±ì—”ë“œì— íŒŒì¼ ì—…ë¡œë“œ `csrf` ì„¤ì •ì´ ë˜ì–´ìˆê¸° ë•Œë¬¸ì— preflight ìš”ì²­ì´ í—¤ë”ì— í¬í•¨ë˜ì–´ì•¼ í•œë‹¤.) ì—¬ê¸°ì„œëŠ” ì£¼ëª©í•´ì•¼í•  ë¶€ë¶„ì€ `asyncAuthLink`ê³¼ `createIamAuthLink`ì´ë‹¤. ì›ë˜ëŠ” ê·¸ë¦¼ì—ì„œ ë³´ì˜€ë“¯ì´ ì¡°ê±´ë¶€ ë§í¬ë¥¼ ìœ„í•œ `amplifyAuthLink`ê°€ ë¶™ì–´ì•¼ í•œë‹¤. `jwt`í† ê·¼ ê¸°ë°˜ ì¸ì¦ìœ¼ë¡œ ì¼ë‹¨ public APIë¡œ ì „í™˜í•œ ìƒíƒœì´ë‹¤(ì˜ ì•ˆëê¸° ë•Œë¬¸ì—...). ì´ê±´ í›„ì— ì„¤ëª…í•˜ê¸°ë¡œ í•˜ê³ , Apollo clientëŠ” ì•„ë˜ í•¨ìˆ˜ë¡œ ìƒì„±í•˜ë©°, ì´ í•¨ìˆ˜ëŠ” `useApolloClient` hookìœ¼ë¡œ ì‹¤í–‰ëœë‹¤.

```typescript
/**
 * It creates an Apollo Client that uses the IAM Auth Link to authenticate with AWS AppSync, and then
 * uses the Upload Link to send GraphQL requests to AWS AppSync
 * @param {string} region - The AWS region where your AppSync API is deployed.
 * @param {string} uri - The endpoint of the GraphQL API.
 * @returns A new ApolloClient instance.
 */
const createApolloClient = (region: string, uri: string) => {
  const httpLink = createUploadLink({
    uri,
    headers: { "apollo-require-preflight": true },
  });
  return new ApolloClient({
    cache: new InMemoryCache(),
    link: from([
      // createIamAuthLink(region, uri), // IAM Auth token setup
      asyncAuthLink, // jwt setup
      httpLink,
    ]),
  });
};
```

```typescript
/**
 * It creates an Apollo Client, and then adds and removes listeners to update the client when the
 * region or uri changes
 * @param {string} region - The region you want to connect to.
 * @param {string} uri - The URI of the GraphQL endpoint.
 * @returns A function that returns an ApolloClient.
 */
export const useApolloClient = (region: string, uri: string) => {
  const [client] = React.useState(() => createApolloClient(region, uri));
  React.useEffect(() => {
    const handler = addListeners(region, uri);
    return () => removeListeners(handler);
  });
  return client;
};
```

### Apollo links

ì—¬ê¸°ì— ì“°ì¸ Apollo Linkë“¤ì€ 4ê°œì´ë‹¤. `createAuthLink`, `createCognitoAuthLink`, `createIamAuthLink`, `cachedAmplifyAuthLink` ëª¨ë‘ ë‹¤ ì“°ëŠ” ê²ƒì€ ì•„ë‹ˆê³ , í•„ìš”ì— ë”°ë¼ ìŠ¤ìœ„ì¹˜í•˜ë„ë¡ ë§Œë“¤ë ¤ê³  í–ˆë‹¤. ì´ˆê¸°ì— ë°í˜”ë“¯ì´ APIëŠ” API Gatewayì— ë¬¼ë¦´ ìƒê°ì´ë‹¤. ì¦‰, `execute-api`ë¡œ Signed í—¤ë”ë¥¼ ì…‹íŒ…í•´ì•¼ í•œë‹¤. ê·¸ëŸ¬ë‚˜ `aws-appsync-auth-link`ëŠ” `appsync`ë¼ëŠ” ìš”ì²­ìœ¼ë¡œ ë³´ë‚´ê²Œ ëœë‹¤. ê²°êµ­ API GatewayëŠ” `InvalidSignedException`ì„ ë±‰ì–´ë‚¸ë‹¤. consoleì—ì„œëŠ” `CORS`ë¥¼ ë±‰ê¸° ë•Œë¬¸ì— Networkíƒ­ì—ì„œ Response ì˜¤ë¥˜ë¥¼ ë³´ë©´ ì—ëŸ¬ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤. ì¦‰, API Gatewayë‚˜ ALBì— Cognitoì¸ì¦ í—¤ë”ë¥¼ ë³´ë‚´ê¸° ìœ„í•´ì„œëŠ” `aws-appsync-auth-link`ë¥¼ ê³ ì³ì„œ ë§Œë“¤ì–´ì•¼ í•˜ëŠ” ê²°ë¡ ì´ ë‚˜ì™”ë‹¤. ê·¸ë˜ì„œ ì¼ë‹¨ APIë¥¼ ì¸ì¦ì—†ì´ ì˜¤í”ˆí•´ë†“ê³  `jwt` í† í°ë§Œ ë‚´ë ¤ë³´ë‚´ê²Œ í•´ë†“ì•˜ë‹¤. ì¦‰ Apollo server ì—ì„œëŠ” í† í°ìœ¼ë¡œ ì‚¬ìš©ì contextë¥¼ ì½ê³  ì²˜ë¦¬ëŠ” ê°€ëŠ¥í•˜ë‹¤. ì¶”í›„ ì´ LinkëŠ” ë§Œë“¤ì–´ì•¼ í•œë‹¤.

```typescript
import { ApolloLink } from "@apollo/client";
import { setContext } from "@apollo/client/link/context";
import { Auth, Hub } from "aws-amplify";
import type { HubCallback } from "@aws-amplify/core";
import { CognitoUserSession } from "amazon-cognito-identity-js";
import { AUTH_TYPE, createAuthLink as awsCreateAuthLink, AuthLink } from "aws-appsync-auth-link";

/**
 * It creates an ApolloLink that uses IAM/Cognito based on sign-in state.
 * Uses a cached AuthLink created by aws-appsync-auth-link under the covers.
 * @param {string} region - The region of the user's identity pool.
 * @param {string} url - The URL of the GraphQL API.
 * @returns A new ApolloLink that is a concatenation of the cachedAmplifyAuthLink and a new ApolloLink
 * that is a request handler.
 */
export const createAuthLink = (region: string, url: string) => {
  return cachedAmplifyAuthLink(region, url).concat(
    new ApolloLink((operation, forward) =>
      operation.getContext().amplifyAuthLink.request(operation, forward)
    )
  );
};

/**
 * Create an AWS AuthLink that uses Cognito, suitable for signed-in users.
 * It takes a CognitoUserSession, a region, and a url, and returns an AuthLink
 * @param {CognitoUserSession} session - The CognitoUserSession object returned from the
 * CognitoUser.getSession() method.
 * @param {string} region - The AWS region where your AppSync API is deployed.
 * @param {string} url - The URL of your GraphQL API.
 */
const createCognitoAuthLink = (session: CognitoUserSession, region: string, url: string) =>
  awsCreateAuthLink({
    auth: {
      jwtToken: session.getIdToken().getJwtToken(),
      type: AUTH_TYPE.AMAZON_COGNITO_USER_POOLS,
    },
    region,
    url,
  });

/* Creating an AuthLink that uses IAM, suitable for non signed-in users. */
export const createIamAuthLink = (region: string, url: string) =>
  awsCreateAuthLink({
    auth: {
      credentials: () => Auth.currentCredentials(),
      type: AUTH_TYPE.AWS_IAM,
    },
    region,
    url,
  });

/**
 * An ApolloLink that uses context to cache the amplifyAuthLink instance.
 * @param {string} region - The AWS region you're using.
 * @param {string} url - The URL of the GraphQL API.
 */
const cachedAmplifyAuthLink = (region: string, url: string) =>
  setContext(() => {
    if (amplifyAuthLink) {
      return { amplifyAuthLink };
    }
    return Auth.currentSession()
      .then((session) => {
        amplifyAuthLink = createCognitoAuthLink(session, region, url);
        return { amplifyAuthLink };
      })
      .catch((error) => {
        amplifyAuthLink = createIamAuthLink(region, url);
        return { amplifyAuthLink };
      });
  });
```

## Amplify API with Unauthenticated role

ì•ì„  [Authentication/Authorization](#authenticationauthorization)ì—ì„œ Amplifyë¡œ ë§Œë“  Lambda functionì´ API Gatewayë¡œ ì—°ê²°ëœ ê²½ìš°ëŠ” ì–´ë–»ê²Œ ë ê¹Œ. ì—¬ê¸°ì„œëŠ” Unauthenticated roleì„ ì ìš©í•œ [Cognito identity pool](https://aws.amazon.com/ko/blogs/compute/control-access-to-your-apis-using-amazon-api-gateway-resource-policies/)ì— ì‚¬ìš©ìê°€ ìƒì„±ì´ ë˜ëŠ”ì§€ í™•ì¸ í•´ë³´ì•˜ë‹¤.

Amplifyì—ì„œ functionì„ ë§Œë“¤ê³ , API endpointë¥¼ ìƒì„±í•œ í›„, Auth roleì„ ë¶™ì—¬ë³¸ë‹¤.

### Lambda í•¨ìˆ˜ ë° API ìƒì„±

```shell
amplify add function
```

ì—¬ê¸°ì„œ TypeScriptë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ Packagesë“¤ì„ ì„¤ì¹˜í•œë‹¤. ì•ì„  tWILì—ì„œ `lib` í´ë”ì—ì„œ íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ê³ , `src`ë¡œ buildí•˜ë„ë¡ ì„¤ì •í–ˆë‹¤. ê·¸ë¦¬ê³  Lambda layerì— í•„ìš”í•œ `dependencies`ë¥¼ ì„¤ì¹˜í•˜ê³ , ì‹ ê·œ Lambdaí•¨ìˆ˜ëŠ” `devDependencies`ë¡œ ì„¤ì¹˜í•œë‹¤. (ìš©ëŸ‰ì„ ì¤„ì´ê¸° ìœ„í•œ í¸ë²•)

![amplify-add-function](/static/images/2022/07/amplify-add-function.png)

ì´ì œ `/unauth`ë¼ëŠ” API Gateway ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë§Œë“¤ê³  ìƒì„±í•œ Lambda í•¨ìˆ˜ë¥¼ ì—°ê²°í•œë‹¤.

![amplify-add-api](/static/images/2022/07/amplify-add-api.png)

`amplify push`í˜¹ì€ CI/CD ì„¤ì •ëœ branchë¡œ pushí•˜ê³  API Gateway ì½˜ì†”ë¡œ ê°€ì„œ ë°°í¬ëœ APIì˜ Resource í•­ëª©ì— Method anyë¥¼ ì„ íƒí•œë‹¤. `Method Request`ë¥¼ ì„ íƒí•˜ê³  `Authorization`ì— `AWS IAM`ìœ¼ë¡œ ìˆ˜ì •í•œë‹¤. [ì°¸ê³ ](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-enable-cognito-user-pool.html)

![aws-apigateway-auth](/static/images/2022/07/aws-apigateway-auth.png)

- Cognito Identity pool([Federeated identities](https://docs.aws.amazon.com/cognito/latest/developerguide/identity-pools.html#authenticated-and-unauthenticated-identities)) ì—ì„œ Edit identity poolë¥¼ í•˜ì—¬, `Unauthenticated role` ì„¤ì •ì— ì²´í¬ë¥¼ í•´ì•¼ í•œë‹¤.
- API Gatewayì—ì„œ Enable CORS ì„¤ì •ì„ í•´ì•¼í•œë‹¤.
- API Gateway Response ì—ì„œ `"Access-Control-Allow-Origin": "*"`, `"Access-Control-Allow-Headers": "*"`ë¥¼ í•´ì£¼ì–´ì•¼ ë¡œì»¬í™˜ê²½ì—ì„œ CORBë¡œ ì»¨í…ì¸ ê°€ ë§‰íˆì§€ ì•ŠëŠ”ë‹¤.
- API Gatewayì˜ Authorizerë¥¼ ë§Œë“¤ì–´ Cognito user poolsë¥¼ ì‚¬ìš©í•œ ê²½ìš°ì—ë„ ë˜ì§€ ì•ŠëŠ”ë‹¤. ì—¬ê¸°ì„œëŠ” [Lambda authorizer](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-integrate-with-cognito.html)ë¡œ ì„¤ì •í•´ì•¼í•˜ëŠ” ê²ƒ ê°™ë‹¤.

### Client

í´ë¼ì´ì–¸íŠ¸ëŠ” RTKë¥¼ ì‚¬ìš©í•œë‹¤ê³  ê°€ì •í•˜ê³ , ë¹„ì¸ì¦ ë¡œì§ì„ í…ŒìŠ¤íŠ¸ í•˜ê¸° ìœ„í•´ thunkë¥¼ ë§Œë“ ë‹¤. RTKQë¥¼ ì“°ì§€ ì•Šê³  Amplifyì˜ `API`ë¥¼ ì‚¬ìš©í•œë‹¤. í•˜ë£¨ ì •ë„ ì´ `API`ì™€ ê´€ë ¨í•˜ì—¬ ì‚½ì§ˆì„ í•œ ê²½ìš°ê°€ ìˆì–´ì„œ ì •ë¦¬í•´ë³¸ë‹¤.

- Headerì— `"Content-Type": "application/json"`ì´ ì„¤ì •ë˜ì–´ì•¼ í•œë‹¤. `application/www-urlencoded` ë“± ë‹¤ë¥¸ ë°©ë²•ì„ ì„¤ì •í•˜ë©´ `403: IncompleteSignatureException` ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.
- POST method: [`POST`](https://docs.amplify.aws/lib/restapi/update/q/platform/js/) methodë¥¼ ì‚¬ìš©í•  ë•Œ ìœ ì˜í•´ì•¼í•  ì ì´ IAM Signatureë¥¼ ë§Œë“¤ ë•Œ Methodê³¼ Content-Typeë˜ ì´ Signatureì— í¬í•¨ë˜ê¸° ë•Œë¬¸ì— ì •í™•í•œ í—¤ë” ê°’ì´ ìš”êµ¬ëœë‹¤. ê·¸ë¦¬ê³  `body`ë¥¼ ì“°ì§€ ì•Šë”ë¼ë„ API Gateway ì¸ì¦ ë£°ì—ì„œëŠ” `body`ë°ì´í„° ë„ í¬í•¨ë˜ì–´ Signatureë¥¼ ë§Œë“¤ê¸° ë•Œë¬¸ì— ë¹„ì–´ìˆë”ë¼ë„ ë§Œë“¤ì–´ì£¼ì–´ì•¼ í•œë‹¤. ì´ `body`ê°’ì„ ì„¤ì •í•˜ì§€ ì•Šì•˜ë‹¤ê³  ê³„ì† `403: InvalidSignatureException` ì—ëŸ¬ë¥¼ ë°°ì¶œ í–ˆì—ˆë‹¤.
- ê·¸ë˜ë„ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ” ê²½ìš° Networkì˜ Responseì—ì„œ `x-amzn-errortype`ì„ í™•ì¸í•˜ì—¬ [ë§í¬](https://aws.amazon.com/ko/premiumsupport/knowledge-center/api-gateway-troubleshoot-403-forbidden/)ì°¸ì¡°í•˜ì—¬ í•´ê²°í•œë‹¤.

```typescript
import { API } from "aws-amplify";
import { createAsyncThunk } from "@reduxjs/toolkit";

export const unauthCheck = createAsyncThunk("auth/unauthCheck", async () => {
  interface Response {
    unauthCheck: boolean;
  }
  const result = (await API.post("unauth", `/unauth`, {
    headers: {
      "Content-Type": "application/json",
    },
    body: {},
  })) as Response;
  return result;
});
```

ë¹„ì¸ê°€ ë£°ì´ ì ìš©ëœ í† í°ìœ¼ë¡œ ì •ìƒì ìœ¼ë¡œ API ìš”ì²­í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.

![amazon-unauth-tokens](/static/images/2022/07/amazon-unauth-tokens.png)

publicìœ¼ë¡œ ìš”ì²­í•˜ê²Œ ë˜ëŠ” ê²½ìš° RTKQë¡œ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ë©´

```typescript
import { createApi, fetchBaseQuery } from "@reduxjs/toolkit/query/react";
import awsExports from "aws-exports";

const {
  aws_cloud_logic_custom: [{ endpoint }],
} = awsExports;

export const apiSlice = createApi({
  reducerPath: "api",
  baseQuery: fetchBaseQuery({
    baseUrl: endpoint,
    prepareHeaders(headers) {
      headers.set("Content-Type", "application/json");
      return headers;
    },
  }),
  endpoints: (builder) => ({
    unauth: builder.mutation({
      query: () => ({
        url: `/unauth`,
        method: "POST",
      }),
    }),
  }),
});

export const { useUnauthMutation } = apiSlice;
```

ì¼ë°˜ API ìš”ì²­ì„ í•˜ê²Œ ë˜ëŠ” ê²½ìš° `401: UnauthorizedException`ì—ëŸ¬ê°€ ë‚˜ì˜¤ë©´ ì •ìƒì´ë‹¤.
